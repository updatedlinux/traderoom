<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeRoom - Gesti贸n de Riesgo para Trading</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
    <link rel="manifest" href="favicon/site.webmanifest">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        /* Loader */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            transition: transform 0.8s ease-in-out;
            transform: scale(1);
        }

        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #010332 0%, #010332 100%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader img {
            width: 80px;
            height: 80px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
        }

        .loader.hidden {
            transform: scale(0);
            pointer-events: none;
        }

        /* Login Section */
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #010332 0%, #010332 100%);
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            color: #010332;
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #010332;
            font-weight: 600;
            font-size: 14px;
        }

        .login-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #010332;
        }

        .login-btn {
            width: 100%;
            background: #010332;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 86, 142, 0.3);
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 86, 142, 0.4);
            background: #010332;
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .success-message {
            color: #2e7d32;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #010332 0%, #010332 100%);
            padding: 10px 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            height: 80px;
        }

        .header-logo-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
        }

        .logo {
            height: 200px;
            width: auto;
            max-width: 300px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            object-fit: contain;
        }

        .header-info {
            color: white;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-info h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-info .last-update {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: #010332;
        }

        /* Sidebar Menu */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 80px);
            position: fixed;
            left: 0;
            top: 80px;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .menu-item {
            padding: 20px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #333;
            font-weight: 600;
        }

        .menu-item:hover {
            background: #f8f9fa;
            color: #010332;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #010332;
            border-left: 4px solid #010332;
        }

        .menu-item i {
            font-size: 20px;
            width: 24px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            margin-top: 80px;
            padding: 30px;
            min-height: calc(100vh - 80px);
            box-sizing: border-box;
            width: calc(100% - 250px);
        }

        .content-section {
            display: none;
            width: 100%;
            box-sizing: border-box;
        }

        .content-section.active {
            display: block;
            width: 100%;
            box-sizing: border-box;
        }

        /* Section Styles */
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            box-sizing: border-box;
            width: 100%;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .section-header h2 {
            color: #010332;
            font-size: 28px;
            font-weight: 700;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #010332;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #010332;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #010332;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Buttons */
        .btn {
            background: #010332;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 86, 142, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 86, 142, 0.4);
            background: #010332;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #010332;
            margin-bottom: 20px;
        }

        .card h3 {
            color: #010332;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .stat-value.positive {
            color: #28a745;
        }

        .stat-value.negative {
            color: #dc3545;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.in_progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.target_hit {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.stopped_loss {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.closed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #010332;
            font-size: 24px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #010332;
        }

        /* Hidden content when not logged in */
        .content-hidden {
            display: none;
        }

        /* Telegram Signals Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-overlay .modal-content {
            background: #1f2937;
            color: #f9fafb;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
        }

        .modal-overlay .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #111827;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .modal-overlay .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #f9fafb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #374151;
            color: #f9fafb;
        }

        .modal-overlay .modal-body {
            padding: 20px;
            overflow: hidden;
            flex: 1;
            background: #111827;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            display: flex;
            flex-direction: column;
        }

        .signals-messages-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .signals-messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .signals-messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .signals-messages-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .signals-messages-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .signal-message {
            background: #1f2937;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            /* Chat bubble style */
            padding: 16px;
            max-width: 85%;
            align-self: flex-start;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: fadeInMessage 0.3s ease-out;
            border: 1px solid #374151;
        }

        @keyframes fadeInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .signal-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            gap: 10px;
        }

        .signal-sender {
            font-weight: 600;
            color: #60a5fa;
            /* Blue accent like example */
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .signal-time {
            color: #9ca3af;
            font-size: 11px;
        }

        .signal-text {
            white-space: pre-wrap;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 14px;
            color: #e5e7eb;
            margin: 0;
            line-height: 1.6;
        }

        .signal-badge-expired {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }

        .signals-messages-container .loading,
        .signals-messages-container .error,
        .signals-messages-container .no-messages {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-size: 14px;
            align-self: center;
            width: 100%;
        }

        .signals-messages-container .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin: 20px;
        }

        /* Trading Controls */
        .trading-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .trade-result-btn {
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
        }

        .trade-result-btn.itm {
            background: #28a745;
        }

        .trade-result-btn.itm:hover {
            background: #218838;
        }

        .trade-result-btn.otm {
            background: #dc3545;
        }

        .trade-result-btn.otm:hover {
            background: #c82333;
        }

        .trade-result-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 10px 20px;
                height: 70px;
            }

            .logo {
                height: 200px;
                width: auto;
                max-width: 300px;
            }

            .sidebar {
                top: 70px;
                min-height: calc(100vh - 70px);
            }

            .main-content {
                margin-top: 70px;
                min-height: calc(100vh - 70px);
            }
        }
    </style>
</head>

<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-overlay">
            <img src="icon-traderoom.png" alt="Cargando...">
        </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div style="text-align: center; margin-bottom: 30px;">
            <img src="logo-traderoom.png" alt="TradeRoom Logo"
                style="max-width: 200px; height: auto; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));">
        </div>
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Iniciar Sesi贸n</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-form-group">
                    <label><i class="fas fa-user"></i> Usuario</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="login-form-group">
                    <label><i class="fas fa-key"></i> Contrase帽a</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesi贸n
                </button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Main Content (hidden until logged in) -->
    <div id="mainContent" class="content-hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-logo-container">
                <img src="logo-traderoom.png" alt="TradeRoom Logo" class="logo">
            </div>
            <div class="header-info">
                <div>
                    <h1>TradeRoom</h1>
                    <div class="last-update" id="lastUpdate">Sistema de Gesti贸n de Riesgo</div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="userInfo" style="margin-right: 10px;"></span>
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar Menu -->
        <div class="sidebar" id="sidebar">
            <!-- Admin Menu -->
            <div id="adminMenu" style="display: none;">
                <div class="menu-item active" onclick="showSection('users')">
                    <i class="fas fa-users"></i>
                    <span>Usuarios</span>
                </div>
                <div class="menu-item" onclick="showSection('adminStatistics')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Estad铆sticas</span>
                </div>
            </div>

            <!-- Trader Menu -->
            <div id="traderMenu" style="display: none;">
                <div class="menu-item active" onclick="showSection('periods')">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Periodos</span>
                </div>
                <div class="menu-item" onclick="showSection('currentSession')">
                    <i class="fas fa-chart-line"></i>
                    <span>Sesi贸n Actual</span>
                </div>
                <div class="menu-item" onclick="showSection('statistics')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Estad铆sticas</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Admin Section: Users -->
            <div id="usersSection" class="content-section">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-users"></i> Gesti贸n de Usuarios</h2>
                        <button class="btn" onclick="openCreateUserModal()">
                            <i class="fas fa-plus"></i> Crear Usuario
                        </button>
                    </div>
                    <div id="usersList">
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
            </div>

            <!-- Trader Section: Periods -->
            <div id="periodsSection" class="content-section">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-calendar-alt"></i> Periodos de Trading</h2>
                        <button class="btn" onclick="openCreatePeriodModal()">
                            <i class="fas fa-plus"></i> Nuevo Periodo
                        </button>
                    </div>
                    <div id="periodsList">
                        <p>Cargando periodos...</p>
                    </div>
                </div>
            </div>

            <!-- Trader Section: Current Session -->
            <div id="currentSessionSection" class="content-section">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-line"></i> Sesi贸n Actual</h2>
                        <button class="btn" onclick="refreshCurrentSession()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label><i class="fas fa-calendar-alt"></i> Seleccionar Periodo</label>
                            <select id="periodSelector" onchange="onPeriodSelectorChange()"
                                style="width: 100%; max-width: 400px;">
                                <option value="">-- Selecciona un periodo --</option>
                            </select>
                        </div>
                    </div>
                    <div id="currentSessionContent">
                        <p>Selecciona un periodo para ver o crear la sesi贸n de hoy.</p>
                    </div>
                </div>
            </div>

            <!-- Trader Section: Statistics -->
            <div id="statisticsSection" class="content-section">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-bar"></i> Estad铆sticas</h2>
                        <button class="btn" onclick="loadStatistics()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    <div id="statisticsContent">
                        <p>Cargando estad铆sticas...</p>
                    </div>
                </div>
            </div>

            <!-- Admin Section: Statistics -->
            <div id="adminStatisticsSection" class="content-section">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-bar"></i> Estad铆sticas de Usuarios</h2>
                        <button class="btn" onclick="loadAdminStatistics()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    <div id="adminStatisticsContent">
                        <p>Cargando estad铆sticas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Create User Modal (Admin) -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Usuario</h2>
                <span class="close" onclick="closeModal('createUser')">&times;</span>
            </div>
            <form id="createUserForm" onsubmit="handleCreateUser(event)">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label>Contrase帽a</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="newUserRole" required>
                        <option value="trader">Trader</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="createUserError" class="error-message" style="display: none;"></div>
                <div id="createUserSuccess" class="success-message" style="display: none;"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-save"></i> Crear Usuario
                </button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal (Admin) -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Usuario</h2>
                <span class="close" onclick="closeModal('editUser')">&times;</span>
            </div>
            <form id="editUserForm" onsubmit="handleUpdateUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="editUsername" readonly>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="editUserActive">
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nueva Contrase帽a (dejar vac铆o para no cambiar)</label>
                    <input type="password" id="editUserPassword" minlength="6">
                </div>
                <div id="editUserError" class="error-message" style="display: none;"></div>
                <div id="editUserSuccess" class="success-message" style="display: none;"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            </form>
        </div>
    </div>

    <!-- Create/Edit Period Modal (Trader) -->
    <div id="createPeriodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="periodModalTitle">Crear Periodo de Trading</h2>
                <span class="close" onclick="closeModal('createPeriod')">&times;</span>
            </div>
            <form id="createPeriodForm" onsubmit="handleCreatePeriod(event)">
                <input type="hidden" id="editPeriodId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Inicio</label>
                        <input type="date" id="periodStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Fin</label>
                        <input type="date" id="periodEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sobrenombre / Apodo</label>
                    <input type="text" id="periodNickname" placeholder="Ej: IQOption, Quotex, Cuenta Demo"
                        maxlength="100">
                    <small style="color: #666; display: block; margin-top: 5px;">Opcional: Un nombre para identificar
                        f谩cilmente este periodo</small>
                </div>
                <div class="form-group">
                    <label>Capital Inicial</label>
                    <input type="number" id="periodInitialCapital" step="0.01" min="0" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Meta Diaria (%)</label>
                        <input type="number" id="periodDailyTarget" step="0.01" min="0" max="100" value="15">
                    </div>
                    <div class="form-group">
                        <label>Payout (%)</label>
                        <input type="number" id="periodProfit" step="0.01" min="0" max="100" value="80">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Riesgo por Operaci贸n (%)</label>
                        <input type="number" id="periodRisk" step="0.01" min="0" max="100" value="5">
                    </div>
                    <div class="form-group">
                        <label>Pasos de Martingala</label>
                        <input type="number" id="periodMartingale" step="1" min="0" max="10" value="3">
                    </div>
                </div>
                <div class="form-group">
                    <label>P茅rdida M谩xima Diaria (%)</label>
                    <input type="number" id="periodMaxLoss" step="0.01" min="0" max="100" value="6">
                </div>
                <div id="createPeriodError" class="error-message" style="display: none;"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-save"></i> Crear Periodo
                </button>
            </form>
        </div>
    </div>

    <!-- Delete Period Confirmation Modal -->
    <div id="deletePeriodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci贸n</h2>
                <span class="close" onclick="closeModal('deletePeriod')">&times;</span>
            </div>
            <div style="padding: 20px 0;">
                <p style="font-size: 16px; margin-bottom: 20px;">
                    驴Est谩s seguro de que deseas eliminar el periodo <strong id="deletePeriodName"></strong>?
                </p>
                <p style="color: #dc3545; font-weight: bold; margin-bottom: 20px;">
                    <i class="fas fa-warning"></i> Esta acci贸n eliminar谩 permanentemente:
                </p>
                <ul style="margin-left: 20px; margin-bottom: 20px;">
                    <li>El periodo completo</li>
                    <li>Todas las sesiones diarias asociadas</li>
                    <li>Todas las operaciones registradas</li>
                </ul>
                <p style="color: #dc3545; font-weight: bold;">
                    Esta acci贸n no se puede deshacer.
                </p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('deletePeriod')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-danger" onclick="confirmDeletePeriod()">
                    <i class="fas fa-trash"></i> Eliminar Definitivamente
                </button>
            </div>
            <div id="deletePeriodError" class="error-message" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Telegram Signals Modal -->
    <div id="signals-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Se帽ales en vivo (Telegram)</h3>
                <button id="btn-close-signals-modal" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="signals-messages-container" class="signals-messages-container">
                    <div class="loading">Cargando mensajes...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Close Session Confirmation Modal -->
    <div id="closeSessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Cierre de Sesi贸n</h2>
                <span class="close" onclick="closeModal('closeSession')">&times;</span>
            </div>
            <div style="padding: 20px 0;">
                <div
                    style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                    <p style="font-size: 16px; margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i> <strong>Advertencia Importante</strong>
                    </p>
                </div>
                <p style="font-size: 16px; margin-bottom: 20px;">
                    驴Est谩s seguro de que deseas cerrar la sesi贸n del d铆a <strong id="closeSessionDate"></strong>?
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #dc3545; font-weight: bold; margin-bottom: 15px;">
                        <i class="fas fa-warning"></i> Al cerrar esta sesi贸n:
                    </p>
                    <ul style="margin-left: 20px; margin-bottom: 0;">
                        <li>No podr谩s registrar m谩s operaciones en esta sesi贸n</li>
                        <li>No podr谩s reabrir esta sesi贸n hasta el d铆a siguiente</li>
                        <li>El capital actual se guardar谩 y ser谩 el capital inicial del pr贸ximo d铆a</li>
                        <li>La sesi贸n quedar谩 marcada como "closed" (cerrada)</li>
                    </ul>
                </div>
                <p style="color: #dc3545; font-weight: bold; margin-bottom: 20px;">
                    Esta acci贸n no se puede deshacer. Solo podr谩s crear una nueva sesi贸n ma帽ana.
                </p>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn" onclick="closeModal('closeSession')" style="flex: 1; background: #6c757d;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-danger" onclick="confirmCloseSession()" style="flex: 1;">
                        <i class="fas fa-lock"></i> Cerrar Sesi贸n Definitivamente
                    </button>
                </div>
            </div>
            <div id="closeSessionError" class="error-message" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- PnL Proyectado Modal -->
    <div id="projectedPnLModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-chart-line"></i> PnL Proyectado</h2>
                <span class="close" onclick="closeModal('projectedPnL')">&times;</span>
            </div>
            <div id="projectedPnLContent" style="padding: 20px 0;">
                <p>Cargando proyecci贸n...</p>
            </div>
        </div>
    </div>

    <!-- PnL Real Modal -->
    <div id="realPnLModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-chart-bar"></i> PnL Real vs Proyectado</h2>
                <span class="close" onclick="closeModal('realPnL')">&times;</span>
            </div>
            <div id="realPnLContent" style="padding: 20px 0;">
                <p>Cargando datos...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuraci贸n
        const IS_PROD = window.location.origin.includes('traderoom.soyjonnymelendez.net');
        // Si estamos en prod, usa el dominio del backend.
        // Si no, si estamos en puero 3000, usa el origen actual.
        // Si no (ej: puerto 80 local), asume backend en puerto 3000 del mismo host.
        const BACKEND_URL = IS_PROD
            ? 'https://backtrade.soyjonnymelendez.net'
            : (window.location.port === '3000' ? window.location.origin : 'http://' + window.location.hostname + ':3000');

        const API_BASE = `${BACKEND_URL}/api`;

        let currentUser = null;
        let currentPeriod = null;
        let currentSession = null;

        // Funci贸n para formatear fechas sin conversi贸n de zona horaria
        function formatDateForDisplay(dateString) {
            if (!dateString) return 'N/A';
            // Si la fecha viene como YYYY-MM-DD, parsearla directamente sin conversi贸n de zona horaria
            if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                const [year, month, day] = dateString.split('T')[0].split('-');
                return `${day}/${month}/${year}`;
            }
            // Si es un objeto Date o timestamp, usar toLocaleDateString con timezone
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', {
                timeZone: 'America/Bogota',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Inicializaci贸n
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
            }, 500);
            checkAuth();
        });

        // Autenticaci贸n
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include' // Incluir cookies en la solicitud
                });
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    showMainContent();
                } else {
                    showLogin();
                }
            } catch (error) {
                // Silenciar el error 401 al cargar la p谩gina (es normal si no hay sesi贸n)
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('mainContent').classList.add('content-hidden');
        }

        function showMainContent() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').classList.remove('content-hidden');
            document.getElementById('userInfo').textContent = currentUser.username;

            // Ocultar ambos men煤s primero
            document.getElementById('adminMenu').style.display = 'none';
            document.getElementById('traderMenu').style.display = 'none';

            // Ocultar secci贸n de usuarios si no es admin
            const usersSection = document.getElementById('usersSection');
            if (usersSection) {
                if (currentUser.role !== 'admin') {
                    usersSection.style.display = 'none';
                    usersSection.classList.remove('active');
                }
            }

            if (currentUser.role === 'admin') {
                document.getElementById('adminMenu').style.display = 'block';
                showSection('users');
            } else {
                document.getElementById('traderMenu').style.display = 'block';
                showSection('periods');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi贸n...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    showMainContent();
                } else {
                    errorDiv.textContent = data.error || 'Error al iniciar sesi贸n';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi贸n. Por favor intenta nuevamente.';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi贸n';
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'GET',
                    credentials: 'include'
                });
                currentUser = null;
                showLogin();
            } catch (error) {
                console.error('Error al cerrar sesi贸n:', error);
            }
        }

        // Navegaci贸n
        function showSection(sectionName) {
            // Validar que solo admin puede acceder a la secci贸n de usuarios
            if (sectionName === 'users' && (!currentUser || currentUser.role !== 'admin')) {
                console.warn('Acceso denegado: Solo administradores pueden acceder a esta secci贸n');
                if (currentUser && currentUser.role === 'trader') {
                    showSection('periods');
                }
                return;
            }

            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

            const sectionElement = document.getElementById(sectionName + 'Section');
            if (!sectionElement) {
                console.error('Secci贸n no encontrada:', sectionName);
                return;
            }

            sectionElement.classList.add('active');
            if (event && event.target) {
                const menuItem = event.target.closest('.menu-item');
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            }

            if (sectionName === 'users') loadUsers();
            else if (sectionName === 'periods') loadPeriods();
            else if (sectionName === 'currentSession') {
                loadPeriodsForSelector();
                if (currentPeriod) {
                    // Si hay un periodo seleccionado, cargar su sesi贸n
                    loadCurrentSession();
                }
            }
            else if (sectionName === 'statistics') loadStatistics();
            else if (sectionName === 'adminStatistics') loadAdminStatistics();
        }

        // Admin Functions
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    renderUsers(data.users);
                }
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<p class="error-message">Error al cargar usuarios</p>';
            }
        }

        function renderUsers(users) {
            const html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Fecha Creaci贸n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.role}</td>
                                <td><span class="status-badge ${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Activo' : 'Inactivo'}</span></td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-small" onclick="openEditUserModal(${user.id}, '${user.username}', ${user.is_active})">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('usersList').innerHTML = html;
        }

        function openCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
            document.getElementById('createUserForm').reset();
        }

        async function handleCreateUser(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('createUserError');
            const successDiv = document.getElementById('createUserSuccess');

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: document.getElementById('newUsername').value,
                        password: document.getElementById('newPassword').value,
                        role: document.getElementById('newUserRole').value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    successDiv.textContent = 'Usuario creado exitosamente';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    setTimeout(() => {
                        closeModal('createUser');
                        loadUsers();
                    }, 1500);
                } else {
                    errorDiv.textContent = data.error || 'Error al crear usuario';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi贸n';
                errorDiv.style.display = 'block';
            }
        }

        function openEditUserModal(id, username, isActive) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').value = username;
            document.getElementById('editUserActive').value = isActive;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserModal').style.display = 'block';
        }

        async function handleUpdateUser(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('editUserError');
            const successDiv = document.getElementById('editUserSuccess');
            const userId = document.getElementById('editUserId').value;

            const updateData = {
                is_active: document.getElementById('editUserActive').value === 'true'
            };

            const newPassword = document.getElementById('editUserPassword').value;
            if (newPassword) {
                updateData.password = newPassword;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                if (data.success) {
                    successDiv.textContent = 'Usuario actualizado exitosamente';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    setTimeout(() => {
                        closeModal('editUser');
                        loadUsers();
                    }, 1500);
                } else {
                    errorDiv.textContent = data.error || 'Error al actualizar usuario';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi贸n';
                errorDiv.style.display = 'block';
            }
        }

        // Trader Functions
        async function loadPeriods() {
            try {
                const response = await fetch(`${API_BASE}/periods`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    renderPeriods(data.periods);
                }
            } catch (error) {
                document.getElementById('periodsList').innerHTML = '<p class="error-message">Error al cargar periodos</p>';
            }
        }

        function renderPeriods(periods) {
            if (periods.length === 0) {
                document.getElementById('periodsList').innerHTML = '<p>No hay periodos creados. Crea uno nuevo para comenzar.</p>';
                return;
            }

            const html = periods.map(period => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">
                            Periodo ${period.id}${period.nickname ? ` - ${period.nickname}` : ''}
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small" onclick="event.stopPropagation(); openEditPeriodModal(${period.id})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); openDeletePeriodModal(${period.id}, '${period.nickname || `Periodo ${period.id}`}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                    <div onclick="selectPeriod(${period.id})" style="cursor: pointer;">
                        <div class="stat-row">
                            <span class="stat-label">Capital Inicial:</span>
                            <span class="stat-value">$${parseFloat(period.initial_capital).toFixed(2)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Capital Actual:</span>
                            <span class="stat-value">$${parseFloat(period.current_capital).toFixed(2)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Rango de Fechas:</span>
                            <span class="stat-value">${formatDateForDisplay(period.start_date)} - ${formatDateForDisplay(period.end_date)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Estado:</span>
                            <span class="status-badge ${period.status}">${period.status}</span>
                        </div>
                        <div class="stat-row" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e9ecef;">
                            <div style="display: flex; gap: 10px; width: 100%;">
                                <button class="btn btn-small" onclick="event.stopPropagation(); openProjectedPnLModal(${period.id})" style="flex: 1;">
                                    <i class="fas fa-chart-line"></i> PnL Proyectado
                                </button>
                                <button class="btn btn-small" onclick="event.stopPropagation(); openRealPnLModal(${period.id})" style="flex: 1;">
                                    <i class="fas fa-chart-bar"></i> PnL Real
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('periodsList').innerHTML = html;
        }

        async function selectPeriod(periodId) {
            try {
                const response = await fetch(`${API_BASE}/periods/${periodId}`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    currentPeriod = data.period;
                    // Actualizar el selector si estamos en la secci贸n de sesi贸n actual
                    const selector = document.getElementById('periodSelector');
                    if (selector) {
                        selector.value = periodId;
                    }
                    showSection('currentSession');
                    loadCurrentSession();
                }
            } catch (error) {
                alert('Error al cargar el periodo');
            }
        }

        async function loadPeriodsForSelector() {
            try {
                const response = await fetch(`${API_BASE}/periods`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    const selector = document.getElementById('periodSelector');
                    if (selector) {
                        // Guardar el valor actual antes de actualizar
                        const currentValue = selector.value;

                        // Limpiar opciones existentes (excepto la primera)
                        selector.innerHTML = '<option value="">-- Selecciona un periodo --</option>';

                        // Agregar periodos
                        data.periods.forEach(period => {
                            const option = document.createElement('option');
                            option.value = period.id;
                            option.textContent = `Periodo ${period.id}${period.nickname ? ` - ${period.nickname}` : ''} (${formatDateForDisplay(period.start_date)} - ${formatDateForDisplay(period.end_date)})`;
                            selector.appendChild(option);
                        });

                        // Restaurar el valor si existe y el periodo sigue disponible
                        if (currentValue && data.periods.find(p => p.id == currentValue)) {
                            selector.value = currentValue;
                        } else if (currentPeriod && data.periods.find(p => p.id == currentPeriod.id)) {
                            selector.value = currentPeriod.id;
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar periodos para el selector:', error);
            }
        }

        async function onPeriodSelectorChange() {
            const selector = document.getElementById('periodSelector');
            const periodId = selector ? selector.value : null;

            if (!periodId || periodId === '') {
                currentPeriod = null;
                currentSession = null;
                document.getElementById('currentSessionContent').innerHTML = '<p>Selecciona un periodo para ver o crear la sesi贸n de hoy.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/periods/${periodId}`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    currentPeriod = data.period;
                    loadCurrentSession();
                } else {
                    alert('Error al cargar el periodo');
                }
            } catch (error) {
                console.error('Error al cargar el periodo:', error);
                alert('Error de conexi贸n');
            }
        }

        function openCreatePeriodModal() {
            document.getElementById('periodModalTitle').textContent = 'Crear Periodo de Trading';
            document.getElementById('createPeriodForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Crear Periodo';
            document.getElementById('editPeriodId').value = '';
            document.getElementById('createPeriodForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('periodStartDate').value = today;
            document.getElementById('periodEndDate').value = today;
            document.getElementById('periodDailyTarget').value = 15;
            document.getElementById('periodProfit').value = 80;
            document.getElementById('periodRisk').value = 5;
            document.getElementById('periodMartingale').value = 3;
            document.getElementById('periodMaxLoss').value = 6;
            document.getElementById('createPeriodError').style.display = 'none';
            document.getElementById('createPeriodModal').style.display = 'block';
        }

        async function openEditPeriodModal(periodId) {
            try {
                const response = await fetch(`${API_BASE}/periods/${periodId}`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    const period = data.period;
                    document.getElementById('periodModalTitle').textContent = 'Editar Periodo de Trading';
                    document.getElementById('createPeriodForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
                    document.getElementById('editPeriodId').value = period.id;
                    document.getElementById('periodStartDate').value = period.start_date;
                    document.getElementById('periodEndDate').value = period.end_date;
                    document.getElementById('periodNickname').value = period.nickname || '';
                    document.getElementById('periodInitialCapital').value = parseFloat(period.initial_capital);
                    document.getElementById('periodDailyTarget').value = parseFloat(period.daily_target_pct) * 100;
                    document.getElementById('periodProfit').value = parseFloat(period.profit_pct) * 100;
                    document.getElementById('periodRisk').value = parseFloat(period.risk_per_trade_pct) * 100;
                    document.getElementById('periodMartingale').value = period.martingale_steps;
                    document.getElementById('periodMaxLoss').value = parseFloat(period.max_daily_loss_pct) * 100;
                    document.getElementById('createPeriodError').style.display = 'none';
                    document.getElementById('createPeriodModal').style.display = 'block';
                } else {
                    alert('Error al cargar el periodo');
                }
            } catch (error) {
                alert('Error de conexi贸n');
            }
        }

        async function handleCreatePeriod(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('createPeriodError');
            const periodId = document.getElementById('editPeriodId').value;
            const isEdit = periodId !== '';

            try {
                const url = isEdit ? `${API_BASE}/periods/${periodId}` : `${API_BASE}/periods`;
                const method = isEdit ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        start_date: document.getElementById('periodStartDate').value,
                        end_date: document.getElementById('periodEndDate').value,
                        nickname: document.getElementById('periodNickname').value.trim() || null,
                        initial_capital: parseFloat(document.getElementById('periodInitialCapital').value),
                        daily_target_pct: parseFloat(document.getElementById('periodDailyTarget').value) / 100,
                        profit_pct: parseFloat(document.getElementById('periodProfit').value) / 100,
                        risk_per_trade_pct: parseFloat(document.getElementById('periodRisk').value) / 100,
                        martingale_steps: parseInt(document.getElementById('periodMartingale').value),
                        max_daily_loss_pct: parseFloat(document.getElementById('periodMaxLoss').value) / 100
                    })
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('createPeriod');
                    loadPeriods();
                    // Actualizar el selector si estamos en la secci贸n de sesi贸n actual
                    if (document.getElementById('currentSessionSection').classList.contains('active')) {
                        loadPeriodsForSelector();
                    }
                } else {
                    errorDiv.textContent = data.error || (isEdit ? 'Error al actualizar periodo' : 'Error al crear periodo');
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi贸n';
                errorDiv.style.display = 'block';
            }
        }

        async function loadCurrentSession() {
            if (!currentPeriod) {
                document.getElementById('currentSessionContent').innerHTML = '<p>Selecciona un periodo del selector para ver o crear la sesi贸n de hoy.</p>';
                return;
            }

            try {
                // Crear o obtener sesi贸n de hoy
                const response = await fetch(`${API_BASE}/periods/${currentPeriod.id}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    // Calcular capital actual y nextStake si no viene del backend
                    const sessionCapital = data.session.currentCapital || (parseFloat(data.session.starting_capital) + parseFloat(data.session.daily_pnl || 0));

                    // Usar el nextStake del backend si est谩 disponible, sino calcularlo
                    // IMPORTANTE: El backend calcula correctamente el nextStake considerando martingala
                    let calculatedNextStake = data.session.nextStake;
                    if (!calculatedNextStake || calculatedNextStake === 0) {
                        // Fallback: calcular stake base (solo si el backend no envi贸 nextStake)
                        calculatedNextStake = sessionCapital * parseFloat(currentPeriod.risk_per_trade_pct);
                        console.warn('Frontend: nextStake no vino del backend, usando c谩lculo fallback:', calculatedNextStake);
                    } else {
                        console.log('Frontend: Usando nextStake del backend:', calculatedNextStake);
                    }

                    currentSession = {
                        ...data.session,
                        currentCapital: sessionCapital,
                        nextStake: calculatedNextStake,
                        nextMartingaleStep: data.session.nextMartingaleStep || 0
                    };
                    renderCurrentSession();
                } else {
                    document.getElementById('currentSessionContent').innerHTML = `<p class="error-message">${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('currentSessionContent').innerHTML = '<p class="error-message">Error al cargar sesi贸n</p>';
            }
        }

        function renderCurrentSession() {
            if (!currentSession) return;

            const session = currentSession;
            // Permitir operar si est谩 in_progress o target_hit (con advertencia)
            // NO permitir si est谩 stopped_loss o closed
            const canTrade = session.status === 'in_progress' || session.status === 'target_hit';
            const canClose = session.status === 'in_progress' || session.status === 'target_hit' || session.status === 'stopped_loss';
            const showTargetHitWarning = session.status === 'target_hit';
            // Usar currentCapital si est谩 disponible, sino calcularlo
            const capital = session.currentCapital || (parseFloat(session.starting_capital) + parseFloat(session.daily_pnl));
            const dailyTarget = session.dailyTarget || (parseFloat(session.starting_capital) * parseFloat(currentPeriod.daily_target_pct));
            const maxLoss = session.maxDailyLoss || (parseFloat(session.starting_capital) * parseFloat(currentPeriod.max_daily_loss_pct));

            // Calcular nextStake si no viene del backend, usando el capital actual (no el inicial)
            // Esto asegura que el stake se recalcule basado en el capital actual, no el inicial
            let calculatedNextStake = session.nextStake;
            if (!calculatedNextStake || calculatedNextStake === 0) {
                calculatedNextStake = capital * parseFloat(currentPeriod.risk_per_trade_pct);
            }

            const html = `
                <div class="card">
                    <h3>Sesi贸n del ${formatDateForDisplay(session.date)}</h3>
                    <div class="stat-row">
                        <span class="stat-label">Capital Inicial:</span>
                        <span class="stat-value">$${parseFloat(session.starting_capital).toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Capital Actual:</span>
                        <span class="stat-value ${parseFloat(session.daily_pnl) >= 0 ? 'positive' : 'negative'}">$${capital.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PnL Diario:</span>
                        <span class="stat-value ${parseFloat(session.daily_pnl) >= 0 ? 'positive' : 'negative'}">$${parseFloat(session.daily_pnl).toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Meta Diaria:</span>
                        <span class="stat-value">$${dailyTarget.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">P茅rdida M谩xima:</span>
                        <span class="stat-value negative">-$${maxLoss.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Operaciones:</span>
                        <span class="stat-value">${session.num_trades || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Estado:</span>
                        <span class="status-badge ${session.status}">${session.status}</span>
                    </div>
                    ${canTrade ? `
                    <div class="stat-row" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #010332;">
                        <span class="stat-label" style="font-size: 18px; font-weight: bold; color: #010332;"><i class="fas fa-dollar-sign"></i> Monto de la Pr贸xima Operaci贸n:</span>
                        <span class="stat-value" style="font-size: 24px; font-weight: bold; color: #010332;">$${calculatedNextStake.toFixed(2)}</span>
                    </div>
                    ` : ''}
                </div>

                ${showTargetHitWarning ? `
                    <div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107; margin: 20px 0;">
                        <h3 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Advertencia</h3>
                        <p style="color: #856404; margin: 0;">
                            Ya se alcanz贸 la meta diaria (target_hit). Puedes continuar operando, pero ten en cuenta que est谩s operando por encima del objetivo establecido.
                        </p>
                    </div>
                ` : ''}

                ${canClose ? `
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <button class="btn" onclick="openCloseSessionModal()" style="background: #6c757d; width: 100%; max-width: 300px;">
                            <i class="fas fa-lock"></i> Cerrar Sesi贸n Diaria
                        </button>
                        <small style="color: #666; display: block; margin-top: 8px;">Cierra esta sesi贸n manualmente. No podr谩s reabrirla hasta el d铆a siguiente.</small>
                    </div>
                ` : ''}
                
                <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #010332;">
                    <button class="btn" id="btn-open-signals-modal" style="background: #010332; width: 100%; max-width: 300px;">
                        <i class="fas fa-satellite-dish"></i>  Ver Se帽ales en vivo
                    </button>
                    <small style="color: #666; display: block; margin-top: 8px;">Visualiza las se帽ales de trading en tiempo real desde Telegram.</small>
                </div>
                ${canTrade ? `
                    <div class="form-group" style="margin: 20px 0;">
                        <label><i class="fas fa-exchange-alt"></i> Par de Divisas</label>
                        <select id="currencyPairSelect" style="width: 100%; max-width: 300px;">
                            <option value="">Selecciona un par</option>
                            <option value="EUR/USD">EUR/USD</option>
                            <option value="GBP/USD">GBP/USD</option>
                            <option value="USD/JPY">USD/JPY</option>
                            <option value="AUD/USD">AUD/USD</option>
                            <option value="USD/CAD">USD/CAD</option>
                            <option value="USD/CHF">USD/CHF</option>
                            <option value="NZD/USD">NZD/USD</option>
                            <option value="EUR/GBP">EUR/GBP</option>
                            <option value="EUR/JPY">EUR/JPY</option>
                            <option value="GBP/JPY">GBP/JPY</option>
                            <option value="AUD/JPY">AUD/JPY</option>
                            <option value="EUR/AUD">EUR/AUD</option>
                            <option value="GBP/AUD">GBP/AUD</option>
                            <option value="BTC/USD">BTC/USD</option>
                            <option value="ETH/USD">ETH/USD</option>
                            <option value="XAU/USD">XAU/USD (Oro)</option>
                            <option value="XAG/USD">XAG/USD (Plata)</option>
                        </select>
                        <input type="text" id="currencyPairCustom" placeholder="O ingresa un par personalizado (ej: EUR/USD)" style="width: 100%; max-width: 300px; margin-top: 10px; display: none;">
                        <button type="button" class="btn btn-small" onclick="toggleCustomPair()" style="margin-top: 10px;">
                            <i class="fas fa-edit"></i> Par Personalizado
                        </button>
                    </div>
                    <div class="form-group" style="margin: 20px 0;">
                        <label><i class="fas fa-percentage"></i> Payout Real (%)</label>
                        <input type="number" id="payoutRealInput" step="0.01" min="0" max="100" value="${(parseFloat(currentPeriod.profit_pct) * 100).toFixed(2)}" style="width: 100%; max-width: 300px;">
                        <small style="color: #666; display: block; margin-top: 5px;">Payout real de esta operaci贸n (por defecto: ${(parseFloat(currentPeriod.profit_pct) * 100).toFixed(2)}%)</small>
                    </div>
                    <div class="form-group" style="margin: 20px 0;">
                        <label><i class="fas fa-dollar-sign"></i> PnL Real (Opcional)</label>
                        <input type="number" id="pnlRealInput" step="0.01" placeholder="Dejar vac铆o para c谩lculo autom谩tico" style="width: 100%; max-width: 300px;">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Si el broker redondea el monto (ej: $8.87  $9), ingresa aqu铆 el PnL real obtenido. 
                            Si se deja vac铆o, se calcular谩 autom谩ticamente con el monto y payout indicados.
                        </small>
                    </div>
                    <div class="trading-controls">
                        <button class="btn trade-result-btn itm" onclick="registerTrade('ITM')">
                            <i class="fas fa-check-circle"></i> ITM (Ganancia)
                        </button>
                        <button class="btn trade-result-btn otm" onclick="registerTrade('OTM')">
                            <i class="fas fa-times-circle"></i> OTM (P茅rdida)
                        </button>
                    </div>
                ` : session.status === 'closed' ? `
                    <div class="card" style="background: #d1ecf1; border-left: 4px solid #0c5460; margin: 20px 0;">
                        <h3 style="color: #0c5460; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Sesi贸n Cerrada</h3>
                        <p style="color: #0c5460; margin: 0;">
                            Esta sesi贸n ha sido cerrada manualmente. No se pueden registrar m谩s operaciones. 
                            El capital actual ($${capital.toFixed(2)}) se ha guardado y ser谩 el capital inicial del pr贸ximo d铆a.
                        </p>
                    </div>
                ` : `
                    <p class="error-message">No se pueden registrar m谩s operaciones. Estado: ${session.status}</p>
                `}

                <div id="tradesList" style="margin-top: 30px;">
                    <h3>Historial de Operaciones</h3>
                    <div id="tradesContent">Cargando...</div>
                </div>
            `;

            document.getElementById('currentSessionContent').innerHTML = html;
            loadTrades();
        }

        async function loadTrades() {
            if (!currentSession) {
                document.getElementById('tradesContent').innerHTML = '<p>No hay sesi贸n activa.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/sessions/${currentSession.id}`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    if (data.session.trades && data.session.trades.length > 0) {
                        renderTrades(data.session.trades);
                    } else {
                        document.getElementById('tradesContent').innerHTML = '<p>No hay operaciones registradas.</p>';
                    }
                } else {
                    document.getElementById('tradesContent').innerHTML = `<p>Error: ${data.error || 'Error al cargar operaciones'}</p>`;
                }
            } catch (error) {
                console.error('Error al cargar trades:', error);
                document.getElementById('tradesContent').innerHTML = '<p>Error al cargar operaciones. Por favor, recarga la p谩gina.</p>';
            }
        }

        function renderTrades(trades) {
            if (trades.length === 0) {
                document.getElementById('tradesContent').innerHTML = '<p>No hay operaciones registradas.</p>';
                return;
            }

            const html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Hora</th>
                            <th>Par</th>
                            <th>Stake</th>
                            <th>Resultado</th>
                            <th>Payout</th>
                            <th>PnL</th>
                            <th>Capital Despu茅s</th>
                            <th>Martingala</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(trade => {
                const tradeDate = new Date(trade.created_at);
                // Formatear hora en GMT-5 (Bogot谩)
                const timeStr = tradeDate.toLocaleTimeString('es-CO', {
                    timeZone: 'America/Bogota',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateStr = tradeDate.toLocaleDateString('es-CO', {
                    timeZone: 'America/Bogota',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                return `
                            <tr>
                                <td>${trade.trade_number}</td>
                                <td>${dateStr} ${timeStr}</td>
                                <td><strong>${trade.currency_pair || 'N/A'}</strong></td>
                                <td>$${parseFloat(trade.stake).toFixed(2)}</td>
                                <td><span class="status-badge ${trade.result === 'ITM' ? 'active' : 'inactive'}">${trade.result}</span></td>
                                <td>${trade.payout_real ? (parseFloat(trade.payout_real) * 100).toFixed(2) + '%' : 'N/A'}</td>
                                <td class="${parseFloat(trade.pnl) >= 0 ? 'positive' : 'negative'}">$${parseFloat(trade.pnl).toFixed(2)}</td>
                                <td>$${parseFloat(trade.capital_after).toFixed(2)}</td>
                                <td>${trade.martingale_step}</td>
                            </tr>
                        `;
            }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tradesContent').innerHTML = html;
        }

        function toggleCustomPair() {
            const select = document.getElementById('currencyPairSelect');
            const custom = document.getElementById('currencyPairCustom');
            if (custom.style.display === 'none') {
                custom.style.display = 'block';
                select.style.display = 'none';
                custom.value = '';
            } else {
                custom.style.display = 'none';
                select.style.display = 'block';
                select.value = '';
            }
        }

        async function registerTrade(result) {
            if (!currentSession) return;

            // Obtener el par de divisas
            const select = document.getElementById('currencyPairSelect');
            const custom = document.getElementById('currencyPairCustom');
            let currencyPair = '';

            if (custom.style.display !== 'none' && custom.value.trim() !== '') {
                currencyPair = custom.value.trim();
            } else if (select.value) {
                currencyPair = select.value;
            } else {
                alert('Por favor selecciona o ingresa un par de divisas');
                return;
            }

            // Obtener el payout real
            const payoutRealInput = document.getElementById('payoutRealInput');
            const payoutRealPercent = parseFloat(payoutRealInput.value);

            if (isNaN(payoutRealPercent) || payoutRealPercent < 0 || payoutRealPercent > 100) {
                alert('Por favor ingresa un payout real v谩lido (0-100%)');
                return;
            }

            // Convertir porcentaje a decimal (ej: 80% -> 0.80)
            const payoutReal = payoutRealPercent / 100;

            // Obtener PnL Real opcional
            const pnlRealInput = document.getElementById('pnlRealInput');
            let pnlReal = null;
            if (pnlRealInput && pnlRealInput.value.trim() !== '') {
                const pnlRealValue = parseFloat(pnlRealInput.value);
                if (!isNaN(pnlRealValue)) {
                    pnlReal = pnlRealValue;
                }
            }

            // Validar formato b谩sico del par
            if (!/^[A-Z]{3}\/[A-Z]{3}$/i.test(currencyPair)) {
                if (!confirm(`El formato del par "${currencyPair}" no es est谩ndar (ej: EUR/USD). 驴Deseas continuar de todas formas?`)) {
                    return;
                }
            }

            let confirmMessage = `驴Registrar operaci贸n ${result} en ${currencyPair.toUpperCase()} con payout ${payoutRealPercent}%?`;
            if (pnlReal !== null) {
                confirmMessage += `\n\nPnL Real: $${pnlReal.toFixed(2)} (se usar谩 este valor en lugar del c谩lculo autom谩tico)`;
            }
            if (!confirm(confirmMessage)) return;

            try {
                const requestBody = {
                    result,
                    currency_pair: currencyPair,
                    payout_real: payoutReal
                };

                // Agregar pnl_real solo si se proporcion贸
                if (pnlReal !== null) {
                    requestBody.pnl_real = pnlReal;
                }

                const response = await fetch(`${API_BASE}/sessions/${currentSession.id}/trades`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (data.success) {
                    // Limpiar el campo PnL Real despu茅s de registrar
                    const pnlRealInput = document.getElementById('pnlRealInput');
                    if (pnlRealInput) {
                        pnlRealInput.value = '';
                    }

                    // Actualizar currentSession con los datos del backend
                    currentSession = {
                        ...currentSession,
                        ...data.session,
                        daily_pnl: data.currentCapital - parseFloat(currentSession.starting_capital),
                        num_trades: data.session.num_trades,
                        status: data.session.status || currentSession.status,
                        nextStake: data.nextStake,
                        nextMartingaleStep: data.nextMartingaleStep,
                        currentCapital: data.currentCapital,
                        dailyTarget: data.dailyTarget,
                        maxDailyLoss: data.maxDailyLoss,
                        isTargetHit: data.isTargetHit
                    };

                    // Limpiar selector
                    if (select) select.value = '';
                    if (custom) custom.value = '';
                    if (custom.style.display !== 'none') {
                        toggleCustomPair();
                    }

                    // Renderizar directamente con los datos actualizados del backend
                    // No recargar desde el servidor para evitar recalcular nextStake incorrectamente
                    renderCurrentSession();
                } else {
                    alert(data.error || 'Error al registrar operaci贸n');
                }
            } catch (error) {
                alert('Error de conexi贸n');
            }
        }

        async function refreshCurrentSession() {
            await loadCurrentSession();
        }

        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/statistics/trader`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    renderTraderStatistics(data);
                } else {
                    document.getElementById('statisticsContent').innerHTML = `<p class="error-message">${data.error || 'Error al cargar estad铆sticas'}</p>`;
                }
            } catch (error) {
                console.error('Error al cargar estad铆sticas:', error);
                document.getElementById('statisticsContent').innerHTML = '<p class="error-message">Error al cargar estad铆sticas</p>';
            }
        }

        function renderTraderStatistics(data) {
            const { statistics, periods } = data;

            let html = `
                <div class="card">
                    <h3>Resumen General</h3>
                    <div class="stat-row">
                        <span class="stat-label">Total Periodos:</span>
                        <span class="stat-value">${statistics.totalPeriods}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Sesiones Cerradas:</span>
                        <span class="stat-value">${statistics.totalSessions}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Operaciones:</span>
                        <span class="stat-value">${statistics.totalTrades}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PnL Total:</span>
                        <span class="stat-value ${parseFloat(statistics.totalPnL) >= 0 ? 'positive' : 'negative'}">$${parseFloat(statistics.totalPnL).toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sesiones con Meta Alcanzada:</span>
                        <span class="stat-value positive">${statistics.sessionsWithTarget}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sesiones con Stop Loss:</span>
                        <span class="stat-value negative">${statistics.sessionsWithStop}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Tasa de xito:</span>
                        <span class="stat-value">${statistics.winRate}%</span>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Sesiones por Periodo</h3>
            `;

            if (periods.length === 0) {
                html += '<p>No hay periodos con sesiones cerradas.</p>';
            } else {
                periods.forEach(period => {
                    if (period.sessions && period.sessions.length > 0) {
                        html += `
                            <div class="card" style="margin-bottom: 20px;">
                                <h3>Periodo ${period.id}${period.nickname ? ` - ${period.nickname}` : ''} - ${formatDateForDisplay(period.start_date)} a ${formatDateForDisplay(period.end_date)}</h3>
                                <div class="stat-row">
                                    <span class="stat-label">Capital Inicial:</span>
                                    <span class="stat-value">$${parseFloat(period.initial_capital).toFixed(2)}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Capital Actual:</span>
                                    <span class="stat-value">$${parseFloat(period.current_capital).toFixed(2)}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Sesiones Cerradas:</span>
                                    <span class="stat-value">${period.sessions.length}</span>
                                </div>
                                
                                <h4 style="margin-top: 20px;">Sesiones</h4>
                                <div style="overflow-x: auto;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Capital Inicial</th>
                                                <th>Capital Final</th>
                                                <th>PnL</th>
                                                <th>Operaciones</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${period.sessions.map(session => `
                                                <tr>
                                                    <td>${formatDateForDisplay(session.date)}</td>
                                                    <td>$${parseFloat(session.starting_capital).toFixed(2)}</td>
                                                    <td>$${parseFloat(session.ending_capital || (parseFloat(session.starting_capital) + parseFloat(session.daily_pnl))).toFixed(2)}</td>
                                                    <td class="${parseFloat(session.daily_pnl) >= 0 ? 'positive' : 'negative'}">$${parseFloat(session.daily_pnl).toFixed(2)}</td>
                                                    <td>${session.num_trades || 0}</td>
                                                    <td><span class="status-badge ${session.status}">${session.status}</span></td>
                                                    <td>
                                                        <button class="btn btn-sm" onclick="downloadSessionExcel(${session.id})">
                                                            <i class="fas fa-download"></i> Excel
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            document.getElementById('statisticsContent').innerHTML = html;
        }

        async function downloadSessionExcel(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/statistics/trader/sessions/${sessionId}/excel`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sesion-${sessionId}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al descargar Excel');
                }
            } catch (error) {
                console.error('Error al descargar Excel:', error);
                alert('Error al descargar Excel');
            }
        }

        async function loadAdminStatistics() {
            try {
                const response = await fetch(`${API_BASE}/statistics/admin`, { credentials: 'include' });
                const data = await response.json();

                if (response.status === 403 || (data && !data.success && data.error && data.error.includes('permisos'))) {
                    document.getElementById('adminStatisticsContent').innerHTML = `
                        <div class="error-message" style="padding: 20px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ff6b6b; margin-bottom: 15px;"></i> 
                            <h3>Acceso Denegado</h3>
                            <p style="margin-top: 10px;">No tienes permisos para acceder a este recurso.</p>
                            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                                Aseg煤rate de estar autenticado como administrador.<br>
                                Rol actual: <strong>${currentUser ? currentUser.role : 'No disponible'}</strong>
                            </p>
                            <button class="btn" onclick="location.reload()" style="margin-top: 20px;">
                                <i class="fas fa-sync-alt"></i> Recargar P谩gina
                            </button>
                        </div>
                    `;
                    return;
                }

                if (data.success) {
                    renderAdminStatistics(data);
                } else {
                    document.getElementById('adminStatisticsContent').innerHTML = `
                        <div class="error-message" style="padding: 20px;">
                            <p><strong>Error:</strong> ${data.error || 'Error al cargar estad铆sticas'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error al cargar estad铆sticas de admin:', error);
                document.getElementById('adminStatisticsContent').innerHTML = `
                    <div class="error-message" style="padding: 20px;">
                        <p><strong>Error de conexi贸n:</strong> ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 12px;">Verifica tu conexi贸n y permisos.</p>
                    </div>
                `;
            }
        }

        function renderAdminStatistics(data) {
            const { globalStats, userStatistics } = data;

            let html = `
                <div class="card">
                    <h3>Estad铆sticas Globales</h3>
                    <div class="stat-row">
                        <span class="stat-label">Total Traders:</span>
                        <span class="stat-value">${globalStats.totalTraders}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Traders Activos:</span>
                        <span class="stat-value">${globalStats.activeTraders}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Periodos:</span>
                        <span class="stat-value">${globalStats.totalPeriods}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Sesiones:</span>
                        <span class="stat-value">${globalStats.totalSessions}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Operaciones:</span>
                        <span class="stat-value">${globalStats.totalTrades}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PnL Total:</span>
                        <span class="stat-value ${parseFloat(globalStats.totalPnL) >= 0 ? 'positive' : 'negative'}">$${parseFloat(globalStats.totalPnL).toFixed(2)}</span>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Estad铆sticas por Usuario</h3>
            `;

            if (userStatistics.length === 0) {
                html += '<p>No hay traders registrados.</p>';
            } else {
                html += `
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Estado</th>
                                    <th>Periodos</th>
                                    <th>Sesiones</th>
                                    <th>Operaciones</th>
                                    <th>PnL Total</th>
                                    <th>Meta Alcanzada</th>
                                    <th>Stop Loss</th>
                                    <th>Tasa xito</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userStatistics.map(user => `
                                    <tr>
                                        <td><strong>${user.username}</strong></td>
                                        <td><span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Activo' : 'Inactivo'}</span></td>
                                        <td>${user.totalPeriods}</td>
                                        <td>${user.totalSessions}</td>
                                        <td>${user.totalTrades}</td>
                                        <td class="${parseFloat(user.totalPnL) >= 0 ? 'positive' : 'negative'}">$${parseFloat(user.totalPnL).toFixed(2)}</td>
                                        <td class="positive">${user.sessionsWithTarget}</td>
                                        <td class="negative">${user.sessionsWithStop}</td>
                                        <td>${user.winRate}%</td>
                                        <td>
                                            <button class="btn btn-sm" onclick="viewUserDetails(${user.userId})">
                                                <i class="fas fa-eye"></i> Ver Detalles
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            document.getElementById('adminStatisticsContent').innerHTML = html;
        }

        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`${API_BASE}/statistics/admin/users/${userId}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    showUserDetailsModal(data.user);
                } else {
                    alert(data.error || 'Error al cargar detalles del usuario');
                }
            } catch (error) {
                console.error('Error al cargar detalles del usuario:', error);
                alert('Error al cargar detalles del usuario');
            }
        }

        function showUserDetailsModal(user) {
            let html = `
                <div class="modal" id="userDetailsModal" style="display: block;">
                    <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>Detalles de Usuario: ${user.username}</h2>
                            <span class="close" onclick="closeUserDetailsModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="card">
                                <h3>Informaci贸n del Usuario</h3>
                                <div class="stat-row">
                                    <span class="stat-label">Usuario:</span>
                                    <span class="stat-value">${user.username}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Rol:</span>
                                    <span class="stat-value">${user.role}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Estado:</span>
                                    <span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Activo' : 'Inactivo'}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Fecha de Creaci贸n:</span>
                                    <span class="stat-value">${new Date(user.createdAt).toLocaleDateString('es-CO', { timeZone: 'America/Bogota' })}</span>
                                </div>
                            </div>
            `;

            if (user.periods && user.periods.length > 0) {
                html += `<h3 style="margin-top: 20px;">Periodos y Sesiones</h3>`;

                user.periods.forEach(period => {
                    html += `
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>Periodo ${period.id}${period.nickname ? ` - ${period.nickname}` : ''} - ${formatDateForDisplay(period.start_date)} a ${formatDateForDisplay(period.end_date)}</h4>
                            <div class="stat-row">
                                <span class="stat-label">Capital Inicial:</span>
                                <span class="stat-value">$${parseFloat(period.initial_capital).toFixed(2)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Capital Actual:</span>
                                <span class="stat-value">$${parseFloat(period.current_capital).toFixed(2)}</span>
                            </div>
                            
                            ${period.sessions && period.sessions.length > 0 ? `
                                <h5 style="margin-top: 15px;">Sesiones (${period.sessions.length})</h5>
                                <div style="overflow-x: auto;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Capital Inicial</th>
                                                <th>Capital Final</th>
                                                <th>PnL</th>
                                                <th>Operaciones</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${period.sessions.map(session => `
                                                <tr>
                                                    <td>${formatDateForDisplay(session.date)}</td>
                                                    <td>$${parseFloat(session.starting_capital).toFixed(2)}</td>
                                                    <td>$${parseFloat(session.ending_capital || (parseFloat(session.starting_capital) + parseFloat(session.daily_pnl))).toFixed(2)}</td>
                                                    <td class="${parseFloat(session.daily_pnl) >= 0 ? 'positive' : 'negative'}">$${parseFloat(session.daily_pnl).toFixed(2)}</td>
                                                    <td>${session.num_trades || 0}</td>
                                                    <td><span class="status-badge ${session.status}">${session.status}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                ${period.sessions.map(session => {
                        if (session.trades && session.trades.length > 0) {
                            return `
                                            <details style="margin-top: 15px;">
                                                <summary style="cursor: pointer; font-weight: bold;">Operaciones de ${formatDateForDisplay(session.date)} (${session.trades.length})</summary>
                                                <div style="overflow-x: auto; margin-top: 10px;">
                                                    <table class="data-table">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>Hora</th>
                                                                <th>Par</th>
                                                                <th>Stake</th>
                                                                <th>Resultado</th>
                                                                <th>Payout</th>
                                                                <th>PnL</th>
                                                                <th>Martingala</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${session.trades.map(trade => {
                                const tradeDate = new Date(trade.created_at);
                                const timeStr = tradeDate.toLocaleTimeString('es-CO', {
                                    timeZone: 'America/Bogota',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                                const dateStr = tradeDate.toLocaleDateString('es-CO', {
                                    timeZone: 'America/Bogota',
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                });
                                return `
                                                                    <tr>
                                                                        <td>${trade.trade_number}</td>
                                                                        <td>${dateStr} ${timeStr}</td>
                                                                        <td>${trade.currency_pair || 'N/A'}</td>
                                                                        <td>$${parseFloat(trade.stake).toFixed(2)}</td>
                                                                        <td><span class="status-badge ${trade.result === 'ITM' ? 'active' : 'inactive'}">${trade.result}</span></td>
                                                                        <td>${trade.payout_real ? (parseFloat(trade.payout_real) * 100).toFixed(2) + '%' : 'N/A'}</td>
                                                                        <td class="${parseFloat(trade.pnl) >= 0 ? 'positive' : 'negative'}">$${parseFloat(trade.pnl).toFixed(2)}</td>
                                                                        <td>${trade.martingale_step}</td>
                                                                    </tr>
                                                                `;
                            }).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </details>
                                        `;
                        }
                        return '';
                    }).join('')}
                            ` : '<p>No hay sesiones en este periodo.</p>'}
                        </div>
                    `;
                });
            } else {
                html += '<p>Este usuario no tiene periodos registrados.</p>';
            }

            html += `
                        </div>
                    </div>
                </div>
            `;

            // Agregar el modal al body si no existe
            let modal = document.getElementById('userDetailsModal');
            if (modal) {
                modal.outerHTML = html;
            } else {
                document.body.insertAdjacentHTML('beforeend', html);
            }
        }

        function closeUserDetailsModal() {
            const modal = document.getElementById('userDetailsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Modal Functions
        function closeModal(modalName) {
            document.getElementById(modalName + 'Modal').style.display = 'none';
        }

        let periodToDelete = null;

        function openDeletePeriodModal(periodId, periodName) {
            periodToDelete = periodId;
            document.getElementById('deletePeriodName').textContent = periodName;
            document.getElementById('deletePeriodError').style.display = 'none';
            document.getElementById('deletePeriodModal').style.display = 'block';
        }

        function openCloseSessionModal() {
            if (!currentSession) {
                alert('No hay sesi贸n activa para cerrar');
                return;
            }

            // Verificar que la sesi贸n no est茅 ya cerrada
            if (currentSession.status === 'closed') {
                alert('Esta sesi贸n ya est谩 cerrada');
                return;
            }

            // Mostrar la fecha de la sesi贸n en el modal
            const sessionDate = formatDateForDisplay(currentSession.date);
            document.getElementById('closeSessionDate').textContent = sessionDate;
            document.getElementById('closeSessionError').style.display = 'none';
            document.getElementById('closeSessionModal').style.display = 'block';
        }

        async function confirmCloseSession() {
            if (!currentSession) {
                alert('No hay sesi贸n activa para cerrar');
                return;
            }

            const errorDiv = document.getElementById('closeSessionError');
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/sessions/${currentSession.id}/close`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('closeSession');
                    alert('Sesi贸n cerrada exitosamente. El capital actual se ha guardado y ser谩 el capital inicial del pr贸ximo d铆a.');

                    // Actualizar la sesi贸n actual con el estado cerrado
                    currentSession = {
                        ...currentSession,
                        status: 'closed',
                        ending_capital: data.session.ending_capital || (parseFloat(currentSession.starting_capital) + parseFloat(currentSession.daily_pnl))
                    };

                    // Re-renderizar la sesi贸n para mostrar el estado cerrado
                    renderCurrentSession();
                } else {
                    errorDiv.textContent = data.error || 'Error al cerrar sesi贸n';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error al cerrar sesi贸n:', error);
                errorDiv.textContent = 'Error de conexi贸n. Por favor, intenta nuevamente.';
                errorDiv.style.display = 'block';
            }
        }

        async function confirmDeletePeriod() {
            if (!periodToDelete) return;

            const errorDiv = document.getElementById('deletePeriodError');
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/periods/${periodToDelete}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('deletePeriod');
                    alert(`Periodo eliminado exitosamente.\nSe eliminaron ${data.deleted.sessions} sesiones y ${data.deleted.trades} operaciones.`);
                    loadPeriods();
                    // Actualizar el selector si estamos en la secci贸n de sesi贸n actual
                    if (document.getElementById('currentSessionSection').classList.contains('active')) {
                        loadPeriodsForSelector();
                    }
                    // Si el periodo eliminado era el actual, limpiar la sesi贸n actual
                    if (currentPeriod && currentPeriod.id === periodToDelete) {
                        currentPeriod = null;
                        currentSession = null;
                        const selector = document.getElementById('periodSelector');
                        if (selector) selector.value = '';
                        document.getElementById('currentSessionContent').innerHTML = '<p>Selecciona un periodo para ver o crear la sesi贸n de hoy.</p>';
                    }
                    periodToDelete = null;
                } else {
                    errorDiv.textContent = data.error || 'Error al eliminar periodo';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi贸n';
                errorDiv.style.display = 'block';
            }
        }

        // Funciones para PnL Proyectado y Real
        async function openProjectedPnLModal(periodId) {
            document.getElementById('projectedPnLModal').style.display = 'block';
            document.getElementById('projectedPnLContent').innerHTML = '<p>Cargando proyecci贸n...</p>';

            try {
                const response = await fetch(`${API_BASE}/periods/${periodId}`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    renderProjectedPnL(data.period);
                } else {
                    document.getElementById('projectedPnLContent').innerHTML = '<p class="error-message">Error al cargar el periodo</p>';
                }
            } catch (error) {
                document.getElementById('projectedPnLContent').innerHTML = '<p class="error-message">Error de conexi贸n</p>';
            }
        }

        function renderProjectedPnL(period) {
            const startDate = new Date(period.start_date + 'T00:00:00');
            const endDate = new Date(period.end_date + 'T00:00:00');
            const dailyTargetPct = parseFloat(period.daily_target_pct);

            let currentCapital = parseFloat(period.initial_capital);
            const projection = [];
            let totalProjectedPnL = 0;

            const currentDate = new Date(startDate);
            let dayNumber = 1;

            while (currentDate <= endDate) {
                const dailyTarget = currentCapital * dailyTargetPct;
                const projectedCapital = currentCapital + dailyTarget;
                totalProjectedPnL += dailyTarget;

                projection.push({
                    day: dayNumber,
                    date: new Date(currentDate),
                    capital: currentCapital,
                    dailyTarget: dailyTarget,
                    projectedCapital: projectedCapital
                });

                currentCapital = projectedCapital;
                currentDate.setDate(currentDate.getDate() + 1);
                dayNumber++;
            }

            const html = `
                <div class="card">
                    <h3>Proyecci贸n de PnL - Periodo ${period.id}${period.nickname ? ` - ${period.nickname}` : ''}</h3>
                    <div class="stat-row">
                        <span class="stat-label">Capital Inicial:</span>
                        <span class="stat-value">$${parseFloat(period.initial_capital).toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Capital Final Proyectado:</span>
                        <span class="stat-value">$${currentCapital.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PnL Total Proyectado:</span>
                        <span class="stat-value positive">$${totalProjectedPnL.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">D铆as del Periodo:</span>
                        <span class="stat-value">${projection.length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Meta Diaria (%):</span>
                        <span class="stat-value">${(dailyTargetPct * 100).toFixed(2)}%</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px; overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>D铆a</th>
                                <th>Fecha</th>
                                <th>Capital Inicial</th>
                                <th>Meta Diaria</th>
                                <th>Capital Final Proyectado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${projection.map(proj => `
                                <tr>
                                    <td>${proj.day}</td>
                                    <td>${formatDateForDisplay(proj.date.toISOString().split('T')[0])}</td>
                                    <td>$${proj.capital.toFixed(2)}</td>
                                    <td class="positive">$${proj.dailyTarget.toFixed(2)}</td>
                                    <td>$${proj.projectedCapital.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('projectedPnLContent').innerHTML = html;
        }

        async function openRealPnLModal(periodId) {
            document.getElementById('realPnLModal').style.display = 'block';
            document.getElementById('realPnLContent').innerHTML = '<p>Cargando datos...</p>';

            try {
                const response = await fetch(`${API_BASE}/periods/${periodId}`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    renderRealPnL(data.period);
                } else {
                    document.getElementById('realPnLContent').innerHTML = '<p class="error-message">Error al cargar el periodo</p>';
                }
            } catch (error) {
                document.getElementById('realPnLContent').innerHTML = '<p class="error-message">Error de conexi贸n</p>';
            }
        }

        function renderRealPnL(period) {
            const startDate = new Date(period.start_date + 'T00:00:00');
            const endDate = new Date(period.end_date + 'T00:00:00');
            const dailyTargetPct = parseFloat(period.daily_target_pct);

            // Calcular proyecci贸n
            let projectedCapital = parseFloat(period.initial_capital);
            const projection = [];
            const currentDate = new Date(startDate);
            let dayNumber = 1;

            while (currentDate <= endDate) {
                const dailyTarget = projectedCapital * dailyTargetPct;
                projection.push({
                    day: dayNumber,
                    date: new Date(currentDate).toISOString().split('T')[0],
                    projectedPnL: dailyTarget,
                    projectedCapital: projectedCapital + dailyTarget
                });
                projectedCapital += dailyTarget;
                currentDate.setDate(currentDate.getDate() + 1);
                dayNumber++;
            }

            // Obtener datos reales de sesiones
            const sessions = period.sessions || [];
            const realData = {};
            sessions.forEach(session => {
                realData[session.date] = {
                    pnl: parseFloat(session.daily_pnl || 0),
                    capital: parseFloat(session.starting_capital) + parseFloat(session.daily_pnl || 0),
                    status: session.status
                };
            });

            // Combinar datos
            const combinedData = projection.map(proj => {
                const real = realData[proj.date] || null;
                return {
                    day: proj.day,
                    date: proj.date,
                    projectedPnL: proj.projectedPnL,
                    realPnL: real ? real.pnl : null,
                    projectedCapital: proj.projectedCapital,
                    realCapital: real ? real.capital : null,
                    hasData: real !== null
                };
            });

            // Calcular totales
            const totalProjectedPnL = projection.reduce((sum, p) => sum + p.projectedPnL, 0);
            const totalRealPnL = sessions.reduce((sum, s) => sum + parseFloat(s.daily_pnl || 0), 0);
            const finalProjectedCapital = parseFloat(period.initial_capital) + totalProjectedPnL;
            const finalRealCapital = parseFloat(period.current_capital);

            // Preparar datos para la gr谩fica
            const chartLabels = combinedData.map(d => formatDateForDisplay(d.date));
            const projectedPnLData = combinedData.map(d => d.projectedPnL);
            const realPnLData = combinedData.map(d => d.realPnL !== null ? d.realPnL : null);

            const html = `
                <div class="card">
                    <h3>PnL Real vs Proyectado - Periodo ${period.id}${period.nickname ? ` - ${period.nickname}` : ''}</h3>
                    <div class="stat-row">
                        <span class="stat-label">Capital Inicial:</span>
                        <span class="stat-value">$${parseFloat(period.initial_capital).toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Capital Final Proyectado:</span>
                        <span class="stat-value">$${finalProjectedCapital.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Capital Final Real:</span>
                        <span class="stat-value ${finalRealCapital >= parseFloat(period.initial_capital) ? 'positive' : 'negative'}">$${finalRealCapital.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PnL Total Proyectado:</span>
                        <span class="stat-value positive">$${totalProjectedPnL.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PnL Total Real:</span>
                        <span class="stat-value ${totalRealPnL >= 0 ? 'positive' : 'negative'}">$${totalRealPnL.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Diferencia:</span>
                        <span class="stat-value ${(totalRealPnL - totalProjectedPnL) >= 0 ? 'positive' : 'negative'}">$${(totalRealPnL - totalProjectedPnL).toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sesiones Registradas:</span>
                        <span class="stat-value">${sessions.length} de ${projection.length}</span>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>Gr谩fica de Desempe帽o Diario</h3>
                    <canvas id="pnlChart" style="max-height: 400px;"></canvas>
                </div>
                
                <div style="margin-top: 20px; overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>D铆a</th>
                                <th>Fecha</th>
                                <th>PnL Proyectado</th>
                                <th>PnL Real</th>
                                <th>Diferencia</th>
                                <th>Capital Proyectado</th>
                                <th>Capital Real</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${combinedData.map(d => {
                const diff = d.realPnL !== null ? (d.realPnL - d.projectedPnL) : null;
                return `
                                <tr style="${d.hasData ? '' : 'opacity: 0.6;'}">
                                    <td>${d.day}</td>
                                    <td>${formatDateForDisplay(d.date)}</td>
                                    <td class="positive">$${d.projectedPnL.toFixed(2)}</td>
                                    <td class="${d.realPnL !== null ? (d.realPnL >= 0 ? 'positive' : 'negative') : ''}">
                                        ${d.realPnL !== null ? `$${d.realPnL.toFixed(2)}` : '-'}
                                    </td>
                                    <td class="${diff !== null ? (diff >= 0 ? 'positive' : 'negative') : ''}">
                                        ${diff !== null ? `$${diff.toFixed(2)}` : '-'}
                                    </td>
                                    <td>$${d.projectedCapital.toFixed(2)}</td>
                                    <td>${d.realCapital !== null ? `$${d.realCapital.toFixed(2)}` : '-'}</td>
                                    <td>
                                        ${d.hasData ? `<span class="status-badge ${realData[d.date].status}">${realData[d.date].status}</span>` : '-'}
                                    </td>
                                </tr>
                            `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('realPnLContent').innerHTML = html;

            // Crear gr谩fica despu茅s de que el HTML est茅 en el DOM
            setTimeout(() => {
                const ctx = document.getElementById('pnlChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'PnL Proyectado',
                                data: projectedPnLData,
                                borderColor: '#010332',
                                backgroundColor: 'rgba(1, 3, 50, 0.1)',
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'PnL Real',
                                data: realPnLData,
                                borderColor: realPnLData.some(v => v !== null && v < 0) ? '#dc3545' : '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.4,
                                fill: false,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += '$' + context.parsed.y.toFixed(2);
                                            } else {
                                                label += 'Sin datos';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>

    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Telegram Signals Script -->
    <script>
        // Variables globales para el visor de se帽ales
        let signalsSocket = null;
        let signalsSocketConnected = false;

        // Elementos est谩ticos
        const signalsModal = document.getElementById('signals-modal');
        const signalsContainer = document.getElementById('signals-messages-container');
        const signalsCloseBtn = document.getElementById('btn-close-signals-modal');

        // Funci贸n para abrir el modal
        window.openSignalsModal = function () {
            if (!signalsModal) return;
            signalsModal.classList.remove('hidden');
            loadInitialMessages();
            connectSocket();
        };

        // Funci贸n para cerrar el modal
        window.closeSignalsModal = function () {
            if (!signalsModal) return;
            signalsModal.classList.add('hidden');
            if (signalsSocket && signalsSocketConnected) {
                try {
                    signalsSocket.disconnect();
                } catch (e) { console.error(e); }
                signalsSocketConnected = false;
            }
        };

        // Event Delegation
        document.addEventListener('click', (e) => {
            const openBtn = e.target.closest('#btn-open-signals-modal');
            if (openBtn) openSignalsModal();
            if (e.target === signalsModal) closeSignalsModal();
        });

        if (signalsCloseBtn) signalsCloseBtn.addEventListener('click', closeSignalsModal);

        async function loadInitialMessages() {
            if (!signalsContainer) return;
            signalsContainer.innerHTML = '<div class="loading">Cargando mensajes...</div>';
            try {
                const res = await fetch(`${API_BASE}/telegram/messages?limit=100`, { credentials: 'include' });
                if (!res.ok) {
                    if (res.status === 503) {
                        signalsContainer.innerHTML = '<div class="error">El visor de se帽ales no est谩 disponible. Verifica la configuraci贸n de Telegram en el servidor.</div>';
                        return;
                    }
                    throw new Error('Error al cargar mensajes');
                }
                const messages = await res.json();
                renderMessages(messages.reverse());
            } catch (err) {
                console.error(err);
                signalsContainer.innerHTML = '<div class="error">No se pudieron cargar las se帽ales. Verifica la conexi贸n al servidor.</div>';
            }
        }

        function renderMessages(messages) {
            if (!signalsContainer) return;
            signalsContainer.innerHTML = '';
            if (messages.length === 0) {
                signalsContainer.innerHTML = '<div class="no-messages">No hay mensajes a煤n. Los mensajes aparecer谩n aqu铆 cuando lleguen al canal de Telegram.</div>';
                return;
            }
            messages.forEach(addMessageToContainer);
            signalsContainer.scrollTop = signalsContainer.scrollHeight;
        }

        function addMessageToContainer(msg) {
            if (!signalsContainer) return;
            const div = document.createElement('div');
            div.className = 'signal-message';

            const dateStr = msg.date || new Date().toISOString();
            const date = new Date(dateStr);
            const timeStr = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Structure: Header (Sender + Time), Content, Badge
            div.innerHTML = `
                <div class="signal-message-header">
                    <span class="signal-sender"><i class="fab fa-telegram-plane"></i> Canal Se帽ales</span>
                    <span class="signal-time">${timeStr}</span>
                </div>
                <pre class="signal-text">${escapeHtml(msg.text)}</pre>
                <div class="signal-badge-expired" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> Se帽al Expirada (>2 min)
                </div>
            `;

            signalsContainer.appendChild(div);

            // Check expiration logic
            checkExpiration(div, date);
        }

        function checkExpiration(messageElement, messageDate) {
            const badge = messageElement.querySelector('.signal-badge-expired');
            if (!badge) return;

            const EXPIRATION_TIME_MS = 2 * 60 * 1000; // 2 minutes

            const updateStatus = () => {
                const now = new Date();
                const diff = now - messageDate;

                if (diff > EXPIRATION_TIME_MS) {
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                    // Schedule next check
                    const remaining = EXPIRATION_TIME_MS - diff;
                    if (remaining > 0) {
                        setTimeout(() => {
                            badge.style.display = 'inline-flex';
                        }, remaining);
                    }
                }
            };

            updateStatus();
        }

        function connectSocket() {
            if (signalsSocketConnected) return;

            try {
                // Determinar URL del backend para socket
                const isProd = window.location.origin.includes('traderoom.soyjonnymelendez.net');
                const backendUrl = isProd
                    ? 'https://backtrade.soyjonnymelendez.net'
                    : (window.location.port === '3000' ? window.location.origin : 'http://' + window.location.hostname + ':3000');

                console.log('Conectando socket de se帽ales a:', backendUrl);
                signalsSocket = io(backendUrl);

                signalsSocket.on('connect', () => {
                    signalsSocketConnected = true;
                    console.log(' Conectado a WebSocket para se帽ales de Telegram');
                });

                signalsSocket.on('telegram:new_message', (msg) => {
                    addMessageToContainer(msg);
                    if (signalsContainer) {
                        signalsContainer.scrollTop = signalsContainer.scrollHeight;
                    }
                });

                signalsSocket.on('disconnect', () => {
                    signalsSocketConnected = false;
                    console.log(' Desconectado de WebSocket');
                });

                signalsSocket.on('connect_error', (error) => {
                    console.error(' Error de conexi贸n WebSocket:', error);
                });
            } catch (error) {
                console.error(' Error al conectar WebSocket:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

    </script>
</body>

</html>